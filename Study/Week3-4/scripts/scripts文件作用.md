# ESM-2 LoRA 微调项目脚本说明

本项目包含一系列脚本，用于对 ESM-2 模型进行 LoRA (Low-Rank Adaptation) 微调、评估和分析。

## 快速开始

1.  **环境设置**: 使用 Conda 根据 `environment.yaml` 文件创建并激活运行环境。
    ```bash
    conda env create -f environment.yaml
    ```

2.  **执行完整流程**: 运行 `pipeline.sh` 脚本将按顺序执行数据处理、模型训练和评估的完整流程。
    ```bash
    bash pipeline.sh
    ```

---

## 脚本功能详解

### 核心流程脚本

*   **`pipeline.sh`**
    *   **功能**: 自动化执行整个项目流程的 Shell 脚本。它会按顺序调用 `3-lora.py` (训练) 和 `4-evaluation.py` (评估)，是项目的一键启动入口。

*   **`3-lora.py`**
    *   **功能**: LoRA 微调的核心脚本。它负责：
        1.  加载预训练的 ESM-2 模型和 Tokenizer。
        2.  配置 LoRA 参数 (`LoraConfig`)，并使用 PEFT 的 `get_peft_model` 将 LoRA 适配器应用到模型上。
        3.  加载自定义的数据集 (`data_set.py`)。
        4.  使用 Hugging Face `Trainer` API 进行模型训练。
        5.  保存训练好的 LoRA 适配器权重。

*   **`4-evaluation.py`**
    *   **功能**: 模型评估脚本。它负责：
        1.  加载原始的 ESM-2 基础模型。
        2.  加载已经训练好的 LoRA 适配器权重并合并到基础模型中。
        3.  在测试数据集上进行推理，并计算评估指标（如准确率、F1-score 等）。
        4.  输出评估结果。

*   **`data_set.py`**
    *   **功能**: 定义数据处理和 PyTorch 数据集类 (`Dataset`)。它处理原始数据（如 CSV 文件），使用 ESM-2 Tokenizer 对蛋白质序列进行编码，并准备模型训练所需的 `input_ids`, `attention_mask` 和 `labels`。

### 辅助与分析脚本

*   **`5-true_DB.py`**
    *   **功能**: 用于处理和生成“真实世界”或基准数据集的脚本。它可能会从原始数据库文件（如 PDB、FASTA）中提取序列和标签，并将其格式化为项目所需的标准格式（如 CSV）。

*   **`lens.py`**
    *   **功能**: 模型可解释性分析工具（"Lens"）。该脚本可能用于探查模型内部的激活值或注意力权重，以理解模型是如何做出预测的。

*   **`lens_norm_plot.py`**
    *   **功能**: 基于 `lens.py` 的分析结果生成可视化图表。例如，绘制模型不同层级的权重范数或注意力分数分布图。

*   **`content.py` & `0mail.py`**
    *   **功能**: 自动化报告脚本。`content.py` 可能用于整理实验结果（如指标、图表路径）成文本或 HTML 格式，然后 `0mail.py` 读取这些内容，通过邮件将实验报告自动发送给指定收件人。

*   **`test.py`**
    *   **功能**: 一个通用的测试脚本，用于快速验证代码的某个模块或功能是否正常工作，例如测试数据加载、模型单步推理等。

### 环境与管理

*   **`environment.yaml`**
    *   **功能**: Conda 环境配置文件。它详细列出了运行此项目所需的所有 Python 包及其版本（如 `torch`, `transformers`, `peft`, `pandas` 等），确保了实验环境的可复现性。

*   **`aws-down.sh`**
    *   **功能**: AWS 资源管理脚本。用于在实验完成后安全地关闭 EC2 实例，以节省云服务成本。

### 文档

*   **`复盘.md`**
    *   **功能**: 项目复盘与知识点总结的 Markdown 文档。以问答的形式整理了 LoRA、ESM-2 微调、实验设计等方面的核心概念和实践要点。

*   **`0-执行细节复盘`**
    *   **功能**: 一个记录实际操作过程中遇到的问题、调试细节和解决方案的备忘录文件。
